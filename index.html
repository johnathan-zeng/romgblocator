<!-- … same <head> and <body> up to here … -->

<div id="result"></div>
<div class="footer">
  For any questions, please email <a href="mailto:zeng.johnathan@gmail.com">zeng.johnathan@gmail.com</a>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/togeojson@0.16.0"></script>
<script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

<script>
let map = L.map('map').setView([42.36, -71.06], 9);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let sites = [], markers = [], tableData = [];

omnivore.kml('MGB-affiliated Rad Onc sites.kml')
  .on('ready', function() {
    this.eachLayer(function(layer) {
      const coords = layer.getLatLng();
      const name = layer.feature.properties.name || 'Unnamed';
      sites.push({name: name, lat: coords.lat, lng: coords.lng});
    });
    this.addTo(map);
  });

function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

function kmToMiles(km) {
  return (km * 0.621371).toFixed(2);
}

function findNearest() {
  const addr = document.getElementById("address").value.trim();
  if (!addr) { alert("Please enter an address."); return; }

  fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(addr + ", Massachusetts, USA")}`)
    .then(res => res.json()).then(data => {
    if (!data.features?.length) { alert("Geocoding failed."); return; }

    clearMarkers();
    document.getElementById("spinner").style.display = "block";
    document.getElementById("result").innerHTML = "";
    tableData = [];

    const [userLng, userLat] = data.features[0].geometry.coordinates;
    const userLoc = L.latLng(userLat, userLng);
    const distances = sites.map(site => {
      const siteLoc = L.latLng(site.lat, site.lng);
      return {...site, distance: userLoc.distanceTo(siteLoc)};
    }).sort((a,b) => a.distance-b.distance).slice(0,3);

    const bounds = L.latLngBounds([userLoc]);
    markers.push(L.marker(userLoc, {
      icon: L.divIcon({html:`<div style="background:#D32F2F;color:white;border-radius:50%;width:24px;height:24px;line-height:24px;text-align:center;">Me</div>`, iconSize:[24,24],iconAnchor:[12,12]})
    }).addTo(map).bindPopup("You").openPopup());
    distances.forEach((site,idx)=>{
      const siteLoc = L.latLng(site.lat, site.lng);
      bounds.extend(siteLoc);
      markers.push(L.marker(siteLoc, {
        icon: L.divIcon({html:`<div style="background:#2E7D32;color:white;border-radius:50%;width:24px;height:24px;line-height:24px;text-align:center;">${idx+1}</div>`, iconSize:[24,24],iconAnchor:[12,12]})
      }).addTo(map).bindPopup(`${idx+1}: ${site.name}`));
    });
    map.fitBounds(bounds.pad(0.2));

    Promise.all(distances.map((site,idx)=>{
      return fetch(`https://router.project-osrm.org/route/v1/driving/${userLng},${userLat};${site.lng},${site.lat}?overview=false`)
      .then(r=>r.json()).then(d=>{
        let miles="?", mins="?";
        if(d.code==="Ok"){
          miles=kmToMiles(d.routes[0].legs[0].distance/1000);
          mins=Math.round(d.routes[0].legs[0].duration/60);
        }
        tableData.push({idx:idx+1,name:site.name,distance:miles,time:mins});
      }).catch(()=>tableData.push({idx:idx+1,name:site.name,distance:"Error",time:"Error"}));
    })).then(()=>{
      renderTable();
      document.getElementById("spinner").style.display="none";
    });
  });
}

function renderTable(sortKey="idx",asc=true){
  const sorted = [...tableData].sort((a,b)=>{
    if(sortKey==="name") return asc?a.name.localeCompare(b.name):b.name.localeCompare(a.name);
    const n1 = parseFloat(a[sortKey]); const n2 = parseFloat(b[sortKey]);
    return asc?(n1-n2):(n2-n1);
  });
  let html = `<strong>Top 3 Closest Sites:</strong>
  <table>
  <thead><tr>
  <th onclick="sortTable('idx')">#</th>
  <th onclick="sortTable('name')">Site</th>
  <th onclick="sortTable('distance')">Miles</th>
  <th onclick="sortTable('time')">Drive Time</th>
  </tr></thead><tbody>`;
  sorted.forEach(row=>{
    html+=`<tr><td>${row.idx}</td><td>${row.name}</td><td>${row.distance}</td><td>${row.time}</td></tr>`;
  });
  html+=`</tbody></table>`;
  document.getElementById("result").innerHTML=html;
}

let sortState={idx:true,name:true,distance:true,time:true};
function sortTable(key){
  sortState[key]=!sortState[key];
  renderTable(key,sortState[key]);
}
</script>
</body>
</html>
